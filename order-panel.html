<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Order Panel — YNA STORE</title>
  <link rel="stylesheet" href="assets/style.css" />
</head>
<body class="app">

<header class="topbar">
  <a class="brand" href="index.html">
    <span class="brand__dot"></span>
    <span class="brand__name">YNA STORE</span>
    <span class="brand__tag">Order Panel</span>
  </a>
</header>

<main class="container">
  <section class="section">
    <h2 class="h2">Order Panel VPS</h2>
    <p class="muted">
      Isi data → pilih RAM → bayar QRIS → setelah sukses, data panel & grup baru muncul.
    </p>

    <div class="card card--glass">
      <form id="panelForm" autocomplete="off">
        <label>Username Panel</label>
        <input required id="username" placeholder="contoh: ynauser" minlength="3" maxlength="15" />

        <label>Password</label>
        <input id="password" placeholder="kosongkan biar auto" />

        <label>WhatsApp</label>
        <input required id="wa" placeholder="08xxxx" />

        <label>Pilih RAM</label>
        <select id="ram">
          <option value="20000">RAM 5 — Rp20.000</option>
          <option value="25000">RAM 8 — Rp25.000</option>
          <option value="30000">RAM 10 — Rp30.000</option>
          <option value="35000">RAM Unlimited — Rp35.000</option>
        </select>

        <button id="btnPay" type="submit" class="btn btn--primary">
          Bayar QRIS & Proses
          <span class="btn__glow"></span>
        </button>

        <p id="msg" class="muted" style="margin-top:12px;"></p>
      </form>
    </div>

    <div class="card" style="margin-top:16px;">
      <b>Kontak Admin:</b><br>
      <a href="https://wa.me/6283173403262">WA 0831-7340-3262</a><br><br>
      <b>Payment Manual:</b><br>
      Dana: 083899782574<br>
      GoPay: 083138675899
    </div>
  </section>
</main>

<script>
  function normWA(input){
    let s = (input||"").trim().replace(/\s+/g,'');
    if (!s) return "";
    // ubah 08xxx -> 628xxx
    if (s.startsWith("08")) s = "62" + s.slice(1);
    s = s.replace(/\D/g,'');
    return s;
  }

  function validUsername(u){
    return /^[a-z0-9]{3,15}$/.test(u);
  }

  function autoPass(username){
    const n = Math.floor(Math.random()*90)+10; // 10-99
    return username + n;
  }

  async function createOrderPanel({wa, username, password, amount}){
    const r = await fetch("/api/order/create",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        type:"panel",
        wa,
        username,
        password,
        ram: amount,
        days: 30
      })
    });
    const data = await r.json();
    if(!r.ok || data.error) throw new Error(data.error || "Gagal membuat order");
    return data; // {order_id, pay_url}
  }

  document.getElementById("panelForm").addEventListener("submit", async (e)=>{
    e.preventDefault();

    const msg = document.getElementById("msg");
    const btn = document.getElementById("btnPay");

    const username = document.getElementById("username").value.trim().toLowerCase();
    let password = document.getElementById("password").value.trim();
    const waRaw = document.getElementById("wa").value;
    const wa = normWA(waRaw);
    const amount = document.getElementById("ram").value;

    msg.textContent = "";

    if(!validUsername(username)){
      msg.textContent = "Username tidak valid. Pakai huruf kecil & angka (3-15).";
      return;
    }
    if(!wa || wa.length < 10){
      msg.textContent = "Nomor WhatsApp tidak valid.";
      return;
    }
    if(!password) password = autoPass(username);

    btn.disabled = true;
    btn.textContent = "Membuat invoice...";
    try{
      const { order_id, pay_url } = await createOrderPanel({wa, username, password, amount});
      // langsung pindah ke halaman bayar Pakasir
      // setelah bayar, user akan diarahkan balik ke /thanks.html?order_id=xxxx
      window.location.href = pay_url;
    }catch(err){
      msg.textContent = "Error: " + (err.message || err);
      btn.disabled = false;
      btn.textContent = "Bayar QRIS & Proses";
    }
  });
</script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<script>
async function createOrder(payload){
  const r = await fetch("/api/order-create",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
  const d = await r.json();
  if(d.error) throw new Error(d.error);
  return d;
}

function renderQR(qrString){
  document.getElementById("qris").innerHTML = "";
  new QRCode(document.getElementById("qris"), {
    text: qrString,
    width: 220,
    height: 220
  });
}

async function pollStatus(order_id){
  while(true){
    const r = await fetch(`/api/order-status?order_id=${encodeURIComponent(order_id)}`);
    const d = await r.json();
    if(d?.order?.status === "completed") return d.order;
    document.getElementById("status").innerText = "Menunggu pembayaran...";
    await new Promise(x=>setTimeout(x, 4000));
  }
}

// ====== CONNECT KE FORM PANEL ======
document.getElementById("panelForm").addEventListener("submit", async (e)=>{
  e.preventDefault();

  const username = document.getElementById("username").value.trim().toLowerCase();
  const wa = document.getElementById("wa").value.trim();
  const plan = document.getElementById("ram").value; // pastikan value="5"|"8"|"10"|"unlimited"

  document.getElementById("payBox").style.display = "block";
  document.getElementById("status").innerText = "Membuat QRIS...";

  try{
    // 1) Create order + dapat qr_string
    const pay = await createOrder({
      type: "panel",
      wa,
      username,
      plan
    });

    document.getElementById("orderInfo").innerHTML =
      `<b>Order ID:</b> ${pay.order_id}<br><b>Nominal:</b> Rp${pay.amount}`;

    // 2) Render QR di website kamu
    renderQR(pay.qr_string);
    document.getElementById("status").innerText = "Scan QRIS lalu bayar. Menunggu konfirmasi...";

    // 3) Poll status
    const order = await pollStatus(pay.order_id);

    document.getElementById("status").innerText = "Pembayaran sukses! Memproses panel...";

    // 4) Setelah sukses bayar -> panggil fulfill (nanti kita buat)
    // const f = await fetch(`/api/fulfill-panel?order_id=${encodeURIComponent(pay.order_id)}`);
    // const fj = await f.json();
    // tampilkan hasil login panel + grup buyer + wa admin

  }catch(err){
    document.getElementById("status").innerText = "Gagal: " + (err.message || err);
  }
});
</script>
</body>
</html>
