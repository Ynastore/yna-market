<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Order Panel ‚Äî YNA STORE</title>
  <link rel="stylesheet" href="assets/style.css" />
  <meta name="theme-color" content="#070913" />
  <style>
    /* Modern tweak (nempel ke style.css kamu) */
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media(max-width:820px){.grid2{grid-template-columns:1fr}}
    .field{display:flex;flex-direction:column;gap:8px;margin:10px 0}
    .input,.select{
      width:100%;padding:12px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(10,14,30,.55);
      color:#fff;outline:none;
    }
    .input:focus,.select:focus{border-color:rgba(120,160,255,.55)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      font-size:12px;color:rgba(255,255,255,.82)
    }
    .muted2{color:rgba(255,255,255,.68);font-size:13px;line-height:1.45}
    .divider{height:1px;background:rgba(255,255,255,.08);margin:14px 0}
    .qrWrap{
      display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start
    }
    .qrBox{
      padding:12px;border-radius:18px;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      display:inline-flex;align-items:center;justify-content:center;
      min-width:250px;min-height:250px
    }
    .btnMini{
      padding:10px 12px;border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      color:#fff;cursor:pointer;
    }
    .ok{color:#7CFFB2}
    .bad{color:#FF8A8A}
    code{background:rgba(255,255,255,.08);padding:2px 6px;border-radius:8px}
  </style>
</head>

<body class="app">

<header class="topbar">
  <a class="brand" href="index.html">
    <span class="brand__dot"></span>
    <span class="brand__name">YNA STORE</span>
    <span class="brand__tag">Order Panel</span>
  </a>
</header>

<main class="container">
  <section class="section">

    <h2 class="h2">Order Panel VPS</h2>
    <p class="muted2">
      Isi data ‚Üí pilih RAM ‚Üí QRIS muncul di website ‚Üí setelah pembayaran sukses,
      sistem otomatis bikin server panel untuk kamu. Data login + grup buyer baru muncul setelah sukses.
    </p>

    <div class="card card--glass" style="margin-top:14px;">
      <form id="panelForm" autocomplete="off">
        <div class="grid2">
          <div class="field">
            <label>Username Panel</label>
            <input class="input" required id="username" placeholder="contoh: ynauser" minlength="3" maxlength="15" />
            <div class="muted2">Hanya huruf kecil + angka (3‚Äì15).</div>
          </div>

          <div class="field">
            <label>Password</label>
            <input class="input" id="password" placeholder="kosongkan biar auto" />
            <div class="muted2">Kalau kosong, password dibuat otomatis.</div>
          </div>

          <div class="field">
            <label>WhatsApp</label>
            <input class="input" required id="wa" placeholder="08xxxx / 62xxxx" />
            <div class="muted2">Format 08‚Ä¶ akan otomatis jadi 62‚Ä¶</div>
          </div>

          <div class="field">
            <label>Pilih RAM</label>
            <select class="select" id="ram" required>
              <option value="20000">RAM 5 ‚Äî Rp20.000</option>
              <option value="25000">RAM 8 ‚Äî Rp25.000</option>
              <option value="30000">RAM 10 ‚Äî Rp30.000</option>
              <option value="35000">RAM Unlimited ‚Äî Rp35.000</option>
            </select>
            <div class="muted2">Durasi default mengikuti sistem panel kamu (misal 30 hari).</div>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button id="btnPay" type="submit" class="btn btn--primary">
            Bayar QRIS & Proses
            <span class="btn__glow"></span>
          </button>

          <span class="chip" id="chipState">‚ö° Siap</span>
        </div>

        <p id="msg" class="muted2" style="margin-top:10px;"></p>
      </form>
    </div>

    <!-- QRIS BOX -->
    <div id="payBox" class="card" style="display:none;margin-top:16px;">
      <h3 class="h3">QRIS Pembayaran</h3>
      <div class="divider"></div>

      <div class="qrWrap">
        <div class="qrBox">
          <div id="qris"></div>
        </div>

        <div style="flex:1;min-width:240px;">
          <p id="status" class="muted2">Menunggu‚Ä¶</p>
          <p class="muted2" id="orderInfo"></p>

          <div class="row" style="margin-top:10px;">
            <button type="button" class="btnMini" id="btnCopyOrder" style="display:none;">Copy Order</button>
            <button type="button" class="btnMini" id="btnReset" style="display:none;">Reset</button>
          </div>

          <div class="muted2" style="margin-top:10px;">
            Tips: Setelah scan & bayar, halaman ini akan update otomatis (tanpa refresh).
          </div>
        </div>
      </div>
    </div>

    <!-- HASIL -->
    <div id="resultBox" class="card" style="display:none;margin-top:16px;">
      <h3 class="h3">‚úÖ Order Berhasil</h3>
      <div class="divider"></div>
      <div id="resultText" class="muted2"></div>
      <div class="row" style="margin-top:12px;">
        <button type="button" class="btnMini" id="btnCopyResult">Copy Data Panel</button>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <b>Kontak Admin:</b><br>
      <a href="https://wa.me/6283173403262">WA 0831-7340-3262</a><br><br>
      <b>Payment Manual:</b><br>
      Dana: 083899782574<br>
      GoPay: 083138675899
    </div>

  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<script>
/**
 * BACKEND WAJIB:
 * - POST /api/order-create
 *    body: { type:"panel", wa, username, password, amount }
 *    return: { order_id, amount, qr_string }
 *
 * - GET /api/order-status?order_id=...&amount=...
 *    return: { order: { status:"pending|completed|failed" } }
 *
 * BACKEND FULFILL:
 * - POST /api/fulfill-panel
 *    body: { order_id, amount, wa, username, password }
 *    return: { panel_url, username, password, server_id, buyer_group, admin_wa }
 */

function $(id){ return document.getElementById(id); }

function normWA(input){
  let s = (input||"").trim().replace(/\s+/g,'');
  if (!s) return "";
  if (s.startsWith("08")) s = "62" + s.slice(1);
  s = s.replace(/\D/g,'');
  return s;
}

function validUsername(u){
  return /^[a-z0-9]{3,15}$/.test(u);
}

function autoPass(username){
  const n = Math.floor(10 + Math.random()*90);
  return `${username}${n}`;
}

function rupiah(n){
  try { return new Intl.NumberFormat('id-ID').format(n); } catch { return String(n); }
}

function setChip(text, cls){
  const el = $("chipState");
  el.textContent = text;
  el.className = "chip " + (cls || "");
}

function setFormDisabled(disabled){
  $("username").disabled = disabled;
  $("password").disabled = disabled;
  $("wa").disabled = disabled;
  $("ram").disabled = disabled;
  $("btnPay").disabled = disabled;
}

async function createOrder(payload){
  const r = await fetch("/api/order-create",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
  const d = await r.json();
  if(!r.ok || d.error) throw new Error(d.error || "Gagal membuat order");
  return d;
}

async function getStatus(order_id, amount){
  const r = await fetch(`/api/order-status?order_id=${encodeURIComponent(order_id)}&amount=${encodeURIComponent(amount)}`);
  const d = await r.json();
  if(!r.ok || d.error) throw new Error(d.error || "Gagal cek status");
  return d;
}

function renderQR(qrString){
  const el = $("qris");
  el.innerHTML = "";
  new QRCode(el, { text: qrString, width: 230, height: 230 });
}

async function pollStatus(order_id, amount){
  while(true){
    const d = await getStatus(order_id, amount);
    const st = d?.order?.status;

    if(st === "completed") return "completed";
    if(st === "failed") throw new Error("Transaksi gagal / dibatalkan");

    $("status").innerHTML = `‚è≥ Menunggu pembayaran...`;
    await new Promise(x=>setTimeout(x, 4000));
  }
}

function resetUI(){
  $("payBox").style.display = "none";
  $("resultBox").style.display = "none";
  $("qris").innerHTML = "";
  $("orderInfo").innerHTML = "";
  $("status").innerText = "Menunggu...";
  $("msg").innerText = "";
  $("btnCopyOrder").style.display = "none";
  $("btnReset").style.display = "none";
  setFormDisabled(false);
  $("btnPay").textContent = "Bayar QRIS & Proses";
  setChip("‚ö° Siap");
}

$("btnReset").addEventListener("click", resetUI);

// MAIN SUBMIT
$("panelForm").addEventListener("submit", async (e)=>{
  e.preventDefault();

  const btn = $("btnPay");
  const msg = $("msg");

  const username = $("username").value.trim().toLowerCase();
  let password  = $("password").value.trim();
  const wa      = normWA($("wa").value);
  const amount  = parseInt($("ram").value, 10);

  msg.innerText = "";
  $("resultBox").style.display = "none";
  $("resultText").innerHTML = "";

  if(!validUsername(username)){
    msg.innerText = "Username tidak valid. Pakai huruf kecil & angka (3‚Äì15).";
    return;
  }
  if(!wa || wa.length < 10){
    msg.innerText = "Nomor WhatsApp tidak valid.";
    return;
  }
  if(!password) password = autoPass(username);
  if(!amount || amount < 1000){
    msg.innerText = "Nominal tidak valid.";
    return;
  }

  // show QR box
  $("payBox").style.display = "block";
  $("status").innerText = "Membuat QRIS...";
  $("orderInfo").innerText = "";
  $("qris").innerHTML = "";
  $("btnCopyOrder").style.display = "none";
  $("btnReset").style.display = "none";

  setFormDisabled(true);
  btn.textContent = "Membuat invoice...";
  setChip("üßæ Buat invoice...");

  try{
    // 1) create order -> dapat qr_string
    const pay = await createOrder({
      type: "panel",
      wa,
      username,
      password,
      amount
    });

    $("orderInfo").innerHTML =
      `<b>Order ID:</b> <code>${pay.order_id}</code><br>` +
      `<b>Nominal:</b> Rp${rupiah(pay.amount)}<br>` +
      `<span class="muted2">Scan QRIS untuk bayar.</span>`;

    renderQR(pay.qr_string);

    $("btnCopyOrder").style.display = "inline-flex";
    $("btnReset").style.display = "inline-flex";

    $("btnCopyOrder").onclick = async () => {
      const txt = `Order ID: ${pay.order_id}\nNominal: Rp${pay.amount}\nUsername: ${username}\nWA: ${wa}`;
      try{ await navigator.clipboard.writeText(txt); $("status").innerHTML = `<span class="ok">‚úÖ Order copied!</span>`; }
      catch{ $("status").innerHTML = `<span class="bad">‚ùå Gagal copy (browser)</span>`; }
    };

    $("status").innerText = "üì≤ Scan QRIS ‚Üí bayar ‚Üí tunggu konfirmasi otomatis...";
    btn.textContent = "Menunggu pembayaran...";
    setChip("‚è≥ Menunggu bayar...");

    // 2) poll status pakasir (BUTUH amount)
    await pollStatus(pay.order_id, pay.amount);

    $("status").innerHTML = `<span class="ok">‚úÖ Pembayaran sukses!</span> Memproses panel...`;
    setChip("üõ†Ô∏è Buat panel...");

    // 3) fulfill-panel: bikin user/server pterodactyl
    const f = await fetch("/api/fulfill-panel", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({
        order_id: pay.order_id,
        amount: pay.amount,
        wa,
        username,
        password
      })
    });

    const fj = await f.json();
    if (!f.ok || fj.error) throw new Error(fj.error || "Gagal proses panel");

    // 4) tampilkan hasil (baru setelah sukses)
    $("resultBox").style.display = "block";
    $("resultText").innerHTML = `
      <div class="row" style="margin-bottom:10px;">
        <span class="chip">üíæ ${fj.plan || "Panel"}</span>
        <span class="chip">üÜî Server ID: <code>${fj.server_id}</code></span>
      </div>

      <b>Login Panel:</b>
      <a href="${fj.panel_url}" target="_blank" rel="noopener">${fj.panel_url}</a><br><br>

      <b>Username:</b> <code>${fj.username}</code><br>
      <b>Password:</b> <code>${fj.password}</code><br><br>

      <b>Grup Buyer:</b>
      <a href="${fj.buyer_group}" target="_blank" rel="noopener">Klik join</a><br>

      <b>Admin WA:</b>
      <a href="https://wa.me/${fj.admin_wa}" target="_blank" rel="noopener">${fj.admin_wa}</a>
    `;

    $("btnCopyResult").onclick = async () => {
      const txt =
`YNA STORE - DATA PANEL
Login: ${fj.panel_url}
Username: ${fj.username}
Password: ${fj.password}
Server ID: ${fj.server_id}
Grup Buyer: ${fj.buyer_group}
Admin WA: ${fj.admin_wa}`;
      try{ await navigator.clipboard.writeText(txt); $("status").innerHTML = `<span class="ok">‚úÖ Data panel copied!</span>`; }
      catch{ $("status").innerHTML = `<span class="bad">‚ùå Gagal copy (browser)</span>`; }
    };

    $("status").innerHTML = `<span class="ok">‚úÖ Selesai.</span> Data panel sudah muncul di atas.`;
    setChip("‚úÖ Sukses", "ok");

    setFormDisabled(false);
    btn.textContent = "Bayar QRIS & Proses";

  }catch(err){
    $("status").innerHTML = `<span class="bad">‚ùå Gagal:</span> ${err.message || err}`;
    setChip("‚ùå Error", "bad");
    setFormDisabled(false);
    btn.textContent = "Bayar QRIS & Proses";
  }
});
</script>

</body>
</html>
