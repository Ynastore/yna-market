<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Order Panel ‚Äî YNA STORE</title>
  <link rel="stylesheet" href="assets/style.css" />
</head>

<body class="app">

<header class="topbar">
  <a class="brand" href="index.html">
    <span class="brand__dot"></span>
    <span class="brand__name">YNA STORE</span>
    <span class="brand__tag">Order Panel</span>
  </a>
</header>

<main class="container">
  <section class="section">
    <h2 class="h2">Order Panel VPS</h2>
    <p class="muted">
      Isi data ‚Üí pilih RAM ‚Üí QRIS muncul di website ‚Üí setelah sukses, data panel & link grup buyer baru muncul.
    </p>

    <div class="card card--glass">
      <form id="panelForm" autocomplete="off">

        <label>Username Panel</label>
        <input required id="username" placeholder="contoh: ynauser" minlength="3" maxlength="15" />

        <label>Password</label>
        <input id="password" placeholder="kosongkan biar auto" />

        <label>WhatsApp</label>
        <input required id="wa" placeholder="08xxxx / 62xxxx" />

        <label>Pilih RAM</label>
        <select id="ram" required>
          <option value="20000">RAM 5 ‚Äî Rp20.000</option>
          <option value="25000">RAM 8 ‚Äî Rp25.000</option>
          <option value="30000">RAM 10 ‚Äî Rp30.000</option>
          <option value="35000">RAM Unlimited ‚Äî Rp35.000</option>
        </select>

        <button id="btnPay" type="submit" class="btn btn--primary">
          Bayar QRIS & Proses
          <span class="btn__glow"></span>
        </button>

        <p id="msg" class="muted" style="margin-top:12px;"></p>
      </form>
    </div>

    <!-- AREA QRIS (muncul setelah klik Bayar) -->
    <div id="payBox" class="card" style="display:none;margin-top:16px;">
      <h3 class="h3">QRIS Pembayaran</h3>
      <div id="qris" style="margin-top:10px;"></div>
      <p id="status" class="muted" style="margin-top:10px;">Menunggu...</p>
      <p class="muted" id="orderInfo" style="margin-top:10px;"></p>
    </div>

    <!-- HASIL (baru muncul kalau sukses bayar + backend fulfill sudah dibuat) -->
    <div id="resultBox" class="card" style="display:none;margin-top:16px;">
      <h3 class="h3">‚úÖ Order Berhasil</h3>
      <div id="resultText" class="muted" style="margin-top:10px;"></div>
    </div>

    <div class="card" style="margin-top:16px;">
      <b>Kontak Admin:</b><br>
      <a href="https://wa.me/6283173403262">WA 0831-7340-3262</a><br><br>

      <b>Payment Manual:</b><br>
      Dana: 083899782574<br>
      GoPay: 083138675899
    </div>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<script>
/**
 * CATATAN:
 * - Halaman ini butuh BACKEND:
 *   POST /api/order-create   -> balikin { order_id, amount, qr_string }
 *   GET  /api/order-status?order_id=... -> balikin { order: { status: "pending|completed|failed" } }
 *   (opsional) GET /api/fulfill-panel?order_id=... -> create/extend pterodactyl, lalu balikin detail login
 */

function normWA(input){
  let s = (input||"").trim().replace(/\s+/g,'');
  if (!s) return "";
  if (s.startsWith("08")) s = "62" + s.slice(1);
  s = s.replace(/\D/g,'');
  return s;
}

function validUsername(u){
  return /^[a-z0-9]{3,15}$/.test(u);
}

function autoPass(username){
  const n = Math.floor(10 + Math.random()*90);
  return `${username}${n}`;
}

function rupiah(n){
  try { return new Intl.NumberFormat('id-ID').format(n); } catch { return String(n); }
}

async function createOrder(payload){
  const r = await fetch("/api/order-create",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
  const d = await r.json();
  if(!r.ok || d.error) throw new Error(d.error || "Gagal membuat order");
  return d;
}

async function getStatus(order_id){
  const r = await fetch(`/api/order-status?order_id=${encodeURIComponent(order_id)}`);
  const d = await r.json();
  if(!r.ok || d.error) throw new Error(d.error || "Gagal cek status");
  return d;
}

function renderQR(qrString){
  const el = document.getElementById("qris");
  el.innerHTML = "";
  new QRCode(el, { text: qrString, width: 220, height: 220 });
}

async function pollStatus(order_id){
  while(true){
    const d = await getStatus(order_id);
    const st = d?.order?.status;

    if(st === "completed") return d.order;
    if(st === "failed") throw new Error("Transaksi gagal / dibatalkan");

    document.getElementById("status").innerText = "‚è≥ Menunggu pembayaran...";
    await new Promise(x=>setTimeout(x, 4000));
  }
}

// ====== MAIN SUBMIT ======
document.getElementById("panelForm").addEventListener("submit", async (e)=>{
  e.preventDefault();

  const msg = document.getElementById("msg");
  const btn = document.getElementById("btnPay");

  const username = document.getElementById("username").value.trim().toLowerCase();
  let password  = document.getElementById("password").value.trim();
  const wa      = normWA(document.getElementById("wa").value);
  const amount  = parseInt(document.getElementById("ram").value, 10);

  msg.textContent = "";
  document.getElementById("resultBox").style.display = "none";
  document.getElementById("resultText").innerHTML = "";

  if(!validUsername(username)){
    msg.textContent = "Username tidak valid (huruf kecil + angka 3-15).";
    return;
  }
  if(!wa || wa.length < 10){
    msg.textContent = "Nomor WhatsApp tidak valid.";
    return;
  }
  if(!password) password = autoPass(username);
  if(!amount || amount < 1000){
    msg.textContent = "Nominal tidak valid.";
    return;
  }

  // tampilkan box QR
  const payBox = document.getElementById("payBox");
  payBox.style.display = "block";
  document.getElementById("status").innerText = "Membuat QRIS...";
  document.getElementById("orderInfo").innerText = "";
  document.getElementById("qris").innerHTML = "";

  btn.disabled = true;
  btn.textContent = "Menunggu pembayaran...";

  try{
    // 1) buat order (backend bikin invoice ke Pakasir via API, balikin qr_string)
    const pay = await createOrder({
      type: "panel",
      wa,
      username,
      password,
      amount
    });

    document.getElementById("orderInfo").innerHTML =
      `<b>Order ID:</b> ${pay.order_id}<br>` +
      `<b>Nominal:</b> Rp${rupiah(pay.amount)}<br>` +
      `<span class="muted">Scan QRIS di bawah ini untuk bayar.</span>`;

    // 2) render QR langsung di website
    renderQR(pay.qr_string);
    document.getElementById("status").innerText = "üì≤ Scan QRIS ‚Üí bayar ‚Üí tunggu konfirmasi otomatis...";

    // 3) polling status sampai completed
    await pollStatus(pay.order_id);

    document.getElementById("status").innerText = "‚úÖ Pembayaran sukses! Memproses panel...";

    // 4) (opsional) panggil fulfill-panel untuk create/extend Pterodactyl
    // Kalau backend kamu sudah siap, UNCOMMENT:
    //
    // const f = await fetch(`/api/fulfill-panel?order_id=${encodeURIComponent(pay.order_id)}`);
    // const fj = await f.json();
    // if(!f.ok || fj.error) throw new Error(fj.error || "Gagal proses panel");
    //
    // document.getElementById("resultBox").style.display = "block";
    // document.getElementById("resultText").innerHTML = `
    //   <b>Login Panel:</b> <a href="${fj.panel_url}" target="_blank">${fj.panel_url}</a><br>
    //   <b>Username:</b> <code>${fj.username}</code><br>
    //   <b>Password:</b> <code>${fj.password}</code><br>
    //   <b>Server ID:</b> <code>${fj.server_id}</code><br><br>
    //   <b>Grup Buyer:</b> <a href="${fj.buyer_group}" target="_blank">Klik join</a><br>
    //   <b>Admin WA:</b> <a href="https://wa.me/6283173403262" target="_blank">0831-7340-3262</a>
    // `;
    //
    // msg.textContent = "";

    // sementara (kalau fulfill belum ada):
    msg.textContent = "Pembayaran sukses. Backend fulfill-panel belum diaktifkan (create panel otomatis).";

    btn.disabled = false;
    btn.textContent = "Bayar QRIS & Proses";

  }catch(err){
    document.getElementById("status").innerText = "‚ùå Gagal: " + (err.message || err);
    btn.disabled = false;
    btn.textContent = "Bayar QRIS & Proses";
  }
});
</script>

</body>
</html>
