<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Order Sewa Bot ‚Äî YNA STORE</title>
  <link rel="stylesheet" href="assets/style.css" />
</head>
<body class="app">

<header class="topbar">
  <a class="brand" href="index.html">
    <span class="brand__dot"></span>
    <span class="brand__name">YNA STORE</span>
    <span class="brand__tag">Sewa Bot</span>
  </a>
</header>

<main class="container">
  <section class="section">
    <h2 class="h2">Sewa Bot YNA</h2>
    <p class="muted">
      Isi data ‚Üí pilih bot & durasi ‚Üí QRIS muncul ‚Üí setelah sukses, klik tombol untuk kirim laporan ke admin.
    </p>

    <div class="card card--glass">
      <form id="sewaForm" autocomplete="off">
        <label>Nama</label>
        <input required id="name" placeholder="contoh: Andi" />

        <label>WhatsApp</label>
        <input required id="wa" placeholder="08xxxx / 62xxxx" />

        <label>Link Grup (untuk dimasukkan bot)</label>
        <input required id="group" placeholder="https://chat.whatsapp.com/xxxx" />

        <label>Pilih Bot</label>
        <select id="bot" required>
          <option value="bot_store_yna">BOT STORE YNA</option>
          <option value="bot_md_yna">BOT MD YNA</option>
          <option value="bot_yna_ai_button">BOT YNA AI BUTTON</option>
        </select>

        <label>Durasi</label>
        <select id="duration" required></select>

        <div class="card" style="margin-top:14px;">
          <div class="muted" id="priceText">Harga: -</div>
          <div class="muted" id="ruleText" style="margin-top:8px;line-height:1.5;">
            <b>NOTE (WAJIB BACA)</b><br>
            ‚úì Bot wajib jadi admin<br>
            ‚úì Jangan spam command<br>
            ‚úì Tidak menerima grup di atas 500 member<br>
            ‚úì Garansi penuh selama masa sewa<br>
            ‚úì Kick bot = Sewa hangus<br>
            ‚úì Pindah grup maksimal 1x<br>
            ‚úì Potongan harga hanya berlaku untuk perpanjangan aktif
          </div>
        </div>

        <button id="btnPay" type="submit" class="btn btn--primary" style="margin-top:14px;">
          Bayar QRIS & Proses
          <span class="btn__glow"></span>
        </button>

        <p id="msg" class="muted" style="margin-top:12px;"></p>
      </form>
    </div>

    <!-- QRIS -->
    <div id="payBox" class="card" style="display:none;margin-top:16px;">
      <h3 class="h3">QRIS Pembayaran</h3>
      <div id="qris" style="margin-top:10px;"></div>
      <p id="status" class="muted" style="margin-top:10px;">Menunggu...</p>
      <p class="muted" id="orderInfo" style="margin-top:10px;"></p>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
        <button id="btnCopyOrder" class="btn" type="button">Copy Order ID</button>
        <button id="btnReset" class="btn" type="button">Reset</button>
      </div>
      <p class="muted" style="margin-top:10px;">
        Tips: Setelah scan & bayar, halaman ini update otomatis (tanpa refresh).
      </p>
    </div>

    <!-- RESULT -->
    <div id="resultBox" class="card" style="display:none;margin-top:16px;">
      <h3 class="h3">‚úÖ Pembayaran Berhasil</h3>
      <div id="resultText" class="muted" style="margin-top:10px;white-space:pre-wrap;"></div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
        <a id="btnWa" class="btn btn--primary" href="#" target="_blank">Kirim ke WA Admin</a>
        <button id="btnCopyMsg" class="btn" type="button">Copy Pesan</button>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <b>Kontak Admin:</b><br>
      <a href="https://wa.me/6283173403262">WA 0831-7340-3262</a><br><br>

      <b>Payment Manual:</b><br>
      Dana: 083899782574<br>
      GoPay: 083138675899
    </div>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<script>
function $(id){ return document.getElementById(id); }

const ADMIN_WA = "6283173403262";

const BOT_LABEL = {
  bot_store_yna: "BOT STORE YNA",
  bot_md_yna: "BOT MD YNA",
  bot_yna_ai_button: "BOT YNA AI BUTTON",
};

// harga sesuai list kamu
const PRICING = {
  bot_store_yna: {
    "1": 12000, "2": 20000, "3": 35000, "5": 50000, "12": 85000, "perm": 150000
  },
  bot_md_yna: {
    "1": 15000, "2": 25000, "3": 40000, "5": 60000, "12": 100000, "perm": 200000
  },
  bot_yna_ai_button: {
    "1": 15000, "2": 25000, "3": 40000, "5": 60000, "12": 100000, "perm": 220000
  }
};

const DURATION_LABEL = {
  "1": "1 Bulan",
  "2": "2 Bulan",
  "3": "3 Bulan",
  "5": "5 Bulan",
  "12": "1 Tahun",
  "perm": "Permanen"
};

function normWA(input){
  let s = (input||"").trim().replace(/\s+/g,'');
  if (!s) return "";
  if (s.startsWith("08")) s = "62" + s.slice(1);
  s = s.replace(/\D/g,'');
  return s;
}

function rupiah(n){
  try { return new Intl.NumberFormat('id-ID').format(n); } catch { return String(n); }
}

function isValidGroupLink(url){
  const s = (url||"").trim();
  // minimal cek format WA group
  return /^https:\/\/chat\.whatsapp\.com\/[A-Za-z0-9]+$/.test(s);
}

function renderQR(qrString){
  $("qris").innerHTML = "";
  new QRCode($("qris"), { text: qrString, width: 220, height: 220 });
}

function setDisabled(dis){
  $("name").disabled = dis;
  $("wa").disabled = dis;
  $("group").disabled = dis;
  $("bot").disabled = dis;
  $("duration").disabled = dis;
  $("btnPay").disabled = dis;
}

function buildDurationOptions(botKey){
  const sel = $("duration");
  sel.innerHTML = "";
  const priceMap = PRICING[botKey];
  const order = ["1","2","3","5","12","perm"];
  for(const k of order){
    const opt = document.createElement("option");
    opt.value = k;
    opt.textContent = `${DURATION_LABEL[k]} ‚Äî Rp${rupiah(priceMap[k])}`;
    sel.appendChild(opt);
  }
}

function currentPrice(){
  const botKey = $("bot").value;
  const durKey = $("duration").value;
  return PRICING[botKey][durKey];
}

function updatePriceUI(){
  const botKey = $("bot").value;
  const durKey = $("duration").value;
  const price = PRICING[botKey][durKey];
  $("priceText").innerHTML = `<b>Harga:</b> Rp${rupiah(price)} (${BOT_LABEL[botKey]} ‚Ä¢ ${DURATION_LABEL[durKey]})`;
}

async function createOrder(payload){
  const r = await fetch("/api/order-create",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
  const d = await r.json();
  if(!r.ok || d.error) throw new Error(d.error || "Gagal membuat order");
  return d;
}

async function getStatus(order_id, amount){
  const r = await fetch(`/api/order-status?order_id=${encodeURIComponent(order_id)}&amount=${encodeURIComponent(amount)}`);
  const d = await r.json();
  if(!r.ok || d.error) throw new Error(d.error || "Gagal cek status");
  return d;
}

async function pollStatus(order_id, amount){
  while(true){
    const d = await getStatus(order_id, amount);
    const st = d?.order?.status;
    if(st === "completed") return d.order;
    if(st === "failed") throw new Error("Transaksi gagal / dibatalkan");
    $("status").innerText = "‚è≥ Menunggu pembayaran...";
    await new Promise(x=>setTimeout(x, 4000));
  }
}

// init
buildDurationOptions($("bot").value);
updatePriceUI();
$("bot").addEventListener("change", ()=>{
  buildDurationOptions($("bot").value);
  updatePriceUI();
});
$("duration").addEventListener("change", updatePriceUI);

let LAST = { order_id:"", amount:0, message:"" };

$("btnCopyOrder").addEventListener("click", async ()=>{
  if(!LAST.order_id) return alert("Belum ada Order ID.");
  try{
    await navigator.clipboard.writeText(LAST.order_id);
    $("btnCopyOrder").textContent = "Copied ‚úÖ";
    setTimeout(()=> $("btnCopyOrder").textContent = "Copy Order ID", 1200);
  }catch{
    alert("Gagal copy.");
  }
});

$("btnCopyMsg").addEventListener("click", async ()=>{
  if(!LAST.message) return alert("Belum ada pesan.");
  try{
    await navigator.clipboard.writeText(LAST.message);
    $("btnCopyMsg").textContent = "Copied ‚úÖ";
    setTimeout(()=> $("btnCopyMsg").textContent = "Copy Pesan", 1200);
  }catch{
    alert("Gagal copy.");
  }
});

$("btnReset").addEventListener("click", ()=>{
  location.reload();
});

$("sewaForm").addEventListener("submit", async (e)=>{
  e.preventDefault();

  const msg = $("msg");
  msg.textContent = "";
  $("resultBox").style.display = "none";
  $("resultText").textContent = "";

  const name = $("name").value.trim();
  const wa = normWA($("wa").value);
  const group = $("group").value.trim();
  const botKey = $("bot").value;
  const durKey = $("duration").value;
  const amount = currentPrice();

  if(!name) return msg.textContent = "Nama wajib diisi.";
  if(!wa || wa.length < 10) return msg.textContent = "WhatsApp tidak valid.";
  if(!isValidGroupLink(group)) return msg.textContent = "Link grup tidak valid. Contoh: https://chat.whatsapp.com/xxxx";
  if(!amount) return msg.textContent = "Harga tidak valid.";

  $("payBox").style.display = "block";
  $("status").innerText = "Membuat QRIS...";
  $("orderInfo").innerText = "";
  $("qris").innerHTML = "";
  setDisabled(true);

  try{
    // payload lengkap (biar backend nggak bilang kurang lengkap)
    const pay = await createOrder({
      type: "sewa",
      name,
      wa,
      group,
      bot: botKey,
      duration: durKey,
      amount
    });

    LAST.order_id = pay.order_id;
    LAST.amount = pay.amount;

    $("orderInfo").innerHTML =
      `<b>Order ID:</b> ${pay.order_id}<br>` +
      `<b>Nominal:</b> Rp${rupiah(pay.amount)}<br>` +
      `<span class="muted">Scan QRIS di bawah ini untuk bayar.</span>`;

    renderQR(pay.qr_string);
    $("status").innerText = "üì≤ Scan QRIS ‚Üí bayar ‚Üí tunggu konfirmasi...";

    await pollStatus(pay.order_id, pay.amount);

    $("status").innerText = "‚úÖ Pembayaran sukses. Siapkan pesan ke admin...";

    const botLabel = BOT_LABEL[botKey];
    const durLabel = DURATION_LABEL[durKey];
    const priceLabel = `Rp${rupiah(amount)}`;

    const message =
`hallo min yna, ${name} udh bayar di website untuk sewa bot ${botLabel} dengan durasi ${durLabel} harganya ${priceLabel}, ini data transaksi ku :
Order ID: ${pay.order_id}
Nominal: ${priceLabel}

ini link grup :
${group}

mohon di proses min`;

    LAST.message = message;

    $("resultBox").style.display = "block";
    $("resultText").textContent = message;

    const waUrl = `https://wa.me/${ADMIN_WA}?text=${encodeURIComponent(message)}`;
    $("btnWa").href = waUrl;

    setDisabled(false);
  }catch(err){
    $("status").innerText = "‚ùå Gagal: " + (err.message || err);
    setDisabled(false);
  }
});
</script>

</body>
</html>
