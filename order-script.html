<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Order Script ‚Äî YNA STORE</title>
  <link rel="stylesheet" href="assets/style.css" />
  <meta name="theme-color" content="#070913" />
  <style>
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media(max-width:820px){.grid2{grid-template-columns:1fr}}
    .field{display:flex;flex-direction:column;gap:8px;margin:10px 0}
    .input,.select{
      width:100%;padding:12px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(10,14,30,.55);
      color:#fff;outline:none;
    }
    .input:focus,.select:focus{border-color:rgba(120,160,255,.55)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      font-size:12px;color:rgba(255,255,255,.82)
    }
    .muted2{color:rgba(255,255,255,.68);font-size:13px;line-height:1.45}
    .divider{height:1px;background:rgba(255,255,255,.08);margin:14px 0}
    .qrWrap{display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start}
    .qrBox{
      padding:12px;border-radius:18px;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      display:inline-flex;align-items:center;justify-content:center;
      min-width:250px;min-height:250px
    }
    .btnMini{
      padding:10px 12px;border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      color:#fff;cursor:pointer;
    }
    .ok{color:#7CFFB2}
    .bad{color:#FF8A8A}
    code{background:rgba(255,255,255,.08);padding:2px 6px;border-radius:8px}
    ul{margin:8px 0 0 18px}
  </style>
</head>

<body class="app">
<header class="topbar">
  <a class="brand" href="index.html">
    <span class="brand__dot"></span>
    <span class="brand__name">YNA STORE</span>
    <span class="brand__tag">Order Script</span>
  </a>
</header>

<main class="container">
  <section class="section">

    <h2 class="h2">Order Script Bot</h2>
    <p class="muted2">
      Pilih script ‚Üí QRIS muncul di website ‚Üí setelah sukses, link download script + grup buyer baru muncul.
    </p>

    <div class="card card--glass" style="margin-top:14px;">
      <form id="scriptForm" autocomplete="off">

        <div class="grid2">
          <div class="field">
            <label>Nama / Username</label>
            <input class="input" required id="name" placeholder="contoh: ynastore / nama kamu" />
          </div>

          <div class="field">
            <label>WhatsApp</label>
            <input class="input" required id="wa" placeholder="08xxxx / 62xxxx" />
          </div>

          <div class="field" style="grid-column:1/-1;">
            <label>Pilih Script</label>
            <select class="select" id="product" required>
              <option value="sc_store" data-price="120000">SC STORE ‚Äî Rp120.000</option>
              <option value="sc_md" data-price="150000">SC MD (Multi Device) ‚Äî Rp150.000</option>
              <option value="sc_yna_ai" data-price="180000">SC YNA AI ‚Äî Rp180.000</option>
            </select>
            <div class="muted2" id="desc"></div>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button id="btnPay" type="submit" class="btn btn--primary">
            Bayar QRIS & Proses
            <span class="btn__glow"></span>
          </button>
          <span class="chip" id="chipState">‚ö° Siap</span>
        </div>

        <p id="msg" class="muted2" style="margin-top:10px;"></p>
      </form>
    </div>

    <div id="payBox" class="card" style="display:none;margin-top:16px;">
      <h3 class="h3">QRIS Pembayaran</h3>
      <div class="divider"></div>

      <div class="qrWrap">
        <div class="qrBox"><div id="qris"></div></div>
        <div style="flex:1;min-width:240px;">
          <p id="status" class="muted2">Menunggu‚Ä¶</p>
          <p class="muted2" id="orderInfo"></p>
          <div class="row" style="margin-top:10px;">
            <button type="button" class="btnMini" id="btnCopyOrder" style="display:none;">Copy Order</button>
            <button type="button" class="btnMini" id="btnReset" style="display:none;">Reset</button>
          </div>
          <div class="muted2" style="margin-top:10px;">Setelah bayar, halaman update otomatis.</div>
        </div>
      </div>
    </div>

    <div id="resultBox" class="card" style="display:none;margin-top:16px;">
      <h3 class="h3">‚úÖ Script Siap!</h3>
      <div class="divider"></div>
      <div id="resultText" class="muted2"></div>
      <div class="row" style="margin-top:12px;">
        <button type="button" class="btnMini" id="btnCopyResult">Copy Info</button>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <b>Kontak Admin:</b><br>
      <a href="https://wa.me/6283173403262">WA 0831-7340-3262</a><br><br>
      <b>Payment Manual:</b><br>
      Dana: 083899782574<br>
      GoPay: 083138675899
    </div>

  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script>
/**
 * BACKEND WAJIB:
 * - POST /api/order-create
 *    body: { type:"script", wa, name, product, amount }
 *    return: { order_id, amount, qr_string }
 *
 * - GET /api/order-status?order_id=...&amount=...
 *    return: { order: { status:"pending|completed|failed" } }
 *
 * BACKEND FULFILL:
 * - POST /api/fulfill-script
 *    body: { order_id, amount, wa, name, product }
 *    return: { download_url, product_name, buyer_group, admin_wa }
 */

function $(id){ return document.getElementById(id); }

function normWA(input){
  let s = (input||"").trim().replace(/\s+/g,'');
  if (!s) return "";
  if (s.startsWith("08")) s = "62" + s.slice(1);
  s = s.replace(/\D/g,'');
  return s;
}
function rupiah(n){ try { return new Intl.NumberFormat('id-ID').format(n); } catch { return String(n); } }
function setChip(t){ $("chipState").textContent = t; }
function setFormDisabled(dis){ $("name").disabled=dis; $("wa").disabled=dis; $("product").disabled=dis; $("btnPay").disabled=dis; }

async function createOrder(payload){
  const r = await fetch("/api/order-create",{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
  const d = await r.json();
  if(!r.ok || d.error) throw new Error(d.error || "Gagal membuat order");
  return d;
}
async function getStatus(order_id, amount){
  const r = await fetch(`/api/order-status?order_id=${encodeURIComponent(order_id)}&amount=${encodeURIComponent(amount)}`);
  const d = await r.json();
  if(!r.ok || d.error) throw new Error(d.error || "Gagal cek status");
  return d;
}
function renderQR(qrString){
  const el = $("qris"); el.innerHTML = "";
  new QRCode(el, { text: qrString, width: 230, height: 230 });
}
async function pollStatus(order_id, amount){
  while(true){
    const d = await getStatus(order_id, amount);
    const st = d?.order?.status;
    if(st === "completed") return true;
    if(st === "failed") throw new Error("Transaksi gagal / dibatalkan");
    $("status").innerText = "‚è≥ Menunggu pembayaran...";
    await new Promise(x=>setTimeout(x, 4000));
  }
}
function resetUI(){
  $("payBox").style.display="none";
  $("resultBox").style.display="none";
  $("qris").innerHTML="";
  $("orderInfo").innerHTML="";
  $("status").innerText="Menunggu‚Ä¶";
  $("msg").innerText="";
  $("btnCopyOrder").style.display="none";
  $("btnReset").style.display="none";
  setFormDisabled(false);
  $("btnPay").textContent="Bayar QRIS & Proses";
  setChip("‚ö° Siap");
}
$("btnReset").addEventListener("click", resetUI);

function updateDesc(){
  const opt = $("product").selectedOptions[0];
  const id = opt.value;
  const price = parseInt(opt.dataset.price,10);
  let text = "";
  if(id==="sc_store"){
    text = "BOT khusus jualan, ¬±200+ fitur fokus transaksi & katalog. Free rename + Free panel unli 1 bulan.";
  } else if(id==="sc_md"){
    text = "Serbaguna 1000+ fitur. Cocok hiburan + jualan. Free rename + Free panel unli 1 bulan.";
  } else {
    text = "BOT paling canggih, 850+ fitur AI modern, type button premium. Full setup.";
  }
  $("desc").innerHTML = `<span class="chip">Rp${rupiah(price)}</span> <span class="muted2">${text}</span>`;
}
updateDesc();
$("product").addEventListener("change", updateDesc);

$("scriptForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  $("msg").innerText = "";
  $("resultBox").style.display="none";
  $("resultText").innerHTML="";

  const name = $("name").value.trim();
  const wa = normWA($("wa").value);
  const opt = $("product").selectedOptions[0];
  const product = opt.value;
  const amount = parseInt(opt.dataset.price,10);

  if(!name){ $("msg").innerText="Nama/Username wajib diisi."; return; }
  if(!wa || wa.length < 10){ $("msg").innerText="Nomor WhatsApp tidak valid."; return; }

  $("payBox").style.display="block";
  $("status").innerText="Membuat QRIS...";
  $("orderInfo").innerHTML="";
  $("qris").innerHTML="";
  $("btnCopyOrder").style.display="none";
  $("btnReset").style.display="none";

  setFormDisabled(true);
  $("btnPay").textContent="Membuat invoice...";
  setChip("üßæ Buat invoice...");

  try{
    const pay = await createOrder({ type:"script", wa, name, product, amount });

    $("orderInfo").innerHTML =
      `<b>Order ID:</b> <code>${pay.order_id}</code><br>`+
      `<b>Nominal:</b> Rp${rupiah(pay.amount)}<br>`+
      `<span class="muted2">Scan QRIS untuk bayar.</span>`;

    renderQR(pay.qr_string);
    $("btnCopyOrder").style.display="inline-flex";
    $("btnReset").style.display="inline-flex";

    $("btnCopyOrder").onclick = async ()=>{
      const txt = `Order Script YNA STORE\nOrder ID: ${pay.order_id}\nNominal: Rp${pay.amount}\nProduk: ${product}\nNama: ${name}\nWA: ${wa}`;
      try{ await navigator.clipboard.writeText(txt); $("status").innerHTML=`<span class="ok">‚úÖ Copied!</span>`; }
      catch{ $("status").innerHTML=`<span class="bad">‚ùå Gagal copy</span>`; }
    };

    $("status").innerText="üì≤ Scan QRIS ‚Üí bayar ‚Üí tunggu konfirmasi...";
    $("btnPay").textContent="Menunggu pembayaran...";
    setChip("‚è≥ Menunggu bayar...");

    await pollStatus(pay.order_id, pay.amount);

    $("status").innerHTML = `<span class="ok">‚úÖ Pembayaran sukses!</span> Menyiapkan link download...`;
    setChip("üì¶ Siapkan script...");

    const f = await fetch("/api/fulfill-script",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ order_id: pay.order_id, amount: pay.amount, wa, name, product })
    });
    const fj = await f.json();
    if(!f.ok || fj.error) throw new Error(fj.error || "Gagal proses script");

    $("resultBox").style.display="block";
    $("resultText").innerHTML = `
      <div class="row" style="margin-bottom:10px;">
        <span class="chip">üìú ${fj.product_name || product}</span>
        <span class="chip">üßæ Order: <code>${pay.order_id}</code></span>
      </div>

      <b>Link Download:</b><br>
      <a href="${fj.download_url}" target="_blank" rel="noopener">${fj.download_url}</a>
      <div class="muted2" style="margin-top:10px;">
        Setelah download, kalau butuh setup tinggal chat admin.
      </div>
      <div class="divider"></div>
      <b>Grup Buyer:</b> <a href="${fj.buyer_group}" target="_blank" rel="noopener">Klik join</a><br>
      <b>Admin WA:</b> <a href="https://wa.me/${fj.admin_wa}" target="_blank" rel="noopener">${fj.admin_wa}</a>
    `;

    $("btnCopyResult").onclick = async ()=>{
      const txt =
`YNA STORE - SCRIPT
Produk: ${fj.product_name || product}
Download: ${fj.download_url}
Grup Buyer: ${fj.buyer_group}
Admin WA: ${fj.admin_wa}
Order ID: ${pay.order_id}`;
      try{ await navigator.clipboard.writeText(txt); $("status").innerHTML = `<span class="ok">‚úÖ Copied!</span>`; }
      catch{ $("status").innerHTML = `<span class="bad">‚ùå Gagal copy</span>`; }
    };

    $("status").innerHTML = `<span class="ok">‚úÖ Selesai.</span> Link download sudah muncul di atas.`;
    setChip("‚úÖ Sukses");

    setFormDisabled(false);
    $("btnPay").textContent="Bayar QRIS & Proses";
  }catch(err){
    $("status").innerHTML = `<span class="bad">‚ùå Gagal:</span> ${err.message || err}`;
    setChip("‚ùå Error");
    setFormDisabled(false);
    $("btnPay").textContent="Bayar QRIS & Proses";
  }
});
</script>
</body>
</html>
