<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Order Script ‚Äî YNA STORE</title>
  <link rel="stylesheet" href="assets/style.css" />
</head>
<body class="app">

<header class="topbar">
  <a class="brand" href="index.html">
    <span class="brand__dot"></span>
    <span class="brand__name">YNA STORE</span>
    <span class="brand__tag">Order Script</span>
  </a>
</header>

<main class="container">
  <section class="section">
    <h2 class="h2">Order Script Bot</h2>
    <p class="muted">Isi data ‚Üí pilih script ‚Üí QRIS muncul di website ‚Üí setelah sukses, link download + grup buyer baru muncul.</p>

    <div class="card card--glass">
      <form id="scriptForm" autocomplete="off">
        <label>Nama / Username</label>
        <input required id="name" placeholder="contoh: ynastore" />

        <label>WhatsApp</label>
        <input required id="wa" placeholder="08xxxx / 62xxxx" />

        <label>Pilih Script</label>
        <select id="product" required>
          <option value="sc_store" data-amount="120000">SC STORE ‚Äî Rp120.000</option>
          <option value="sc_md" data-amount="150000">SC MD (Multi Device) ‚Äî Rp150.000</option>
          <option value="sc_yna_ai" data-amount="180000">SC YNA AI ‚Äî Rp180.000</option>
        </select>

        <p id="desc" class="muted" style="margin-top:10px;"></p>

        <button id="btnPay" type="submit" class="btn btn--primary">
          Bayar QRIS & Proses
          <span class="btn__glow"></span>
        </button>

        <p id="msg" class="muted" style="margin-top:12px;"></p>
      </form>
    </div>

    <!-- QRIS -->
    <div id="payBox" class="card" style="display:none;margin-top:16px;">
      <h3 class="h3">QRIS Pembayaran</h3>
      <div id="qris" style="margin-top:10px;"></div>
      <p id="status" class="muted" style="margin-top:10px;">Menunggu...</p>
      <p class="muted" id="orderInfo" style="margin-top:10px;"></p>
    </div>

    <!-- RESULT -->
    <div id="resultBox" class="card" style="display:none;margin-top:16px;">
      <h3 class="h3">‚úÖ Order Script Berhasil</h3>
      <div id="resultText" class="muted" style="margin-top:10px;"></div>
      <button id="btnCopy" class="btn" style="margin-top:12px;">Copy Data</button>
    </div>

    <div class="card" style="margin-top:16px;">
      <b>Kontak Admin:</b><br>
      <a href="https://wa.me/6283173403262">WA 0831-7340-3262</a><br><br>
      <b>Payment Manual:</b><br>
      Dana: 083899782574<br>
      GoPay: 083138675899
    </div>

  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script>
function $(id){ return document.getElementById(id); }

function normWA(input){
  let s = (input||"").trim().replace(/\s+/g,'');
  if (!s) return "";
  if (s.startsWith("08")) s = "62" + s.slice(1);
  s = s.replace(/\D/g,'');
  return s;
}

function rupiah(n){
  try { return new Intl.NumberFormat('id-ID').format(n); } catch { return String(n); }
}

function renderQR(qrString){
  $("qris").innerHTML = "";
  new QRCode($("qris"), { text: qrString, width: 220, height: 220 });
}

async function createOrder(payload){
  const r = await fetch("/api/order-create",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
  const d = await r.json();
  if(!r.ok || d.error) throw new Error(d.error || "Gagal membuat order");
  return d;
}

async function getStatus(order_id, amount){
  const r = await fetch(`/api/order-status?order_id=${encodeURIComponent(order_id)}&amount=${encodeURIComponent(amount)}`);
  const d = await r.json();
  if(!r.ok || d.error) throw new Error(d.error || "Gagal cek status");
  return d;
}

async function pollStatus(order_id, amount){
  while(true){
    const d = await getStatus(order_id, amount);
    const st = d?.order?.status;
    if(st === "completed") return d.order;
    if(st === "failed") throw new Error("Transaksi gagal / dibatalkan");
    $("status").innerText = "‚è≥ Menunggu pembayaran...";
    await new Promise(x=>setTimeout(x, 4000));
  }
}

function updateDesc(){
  const val = $("product").value;
  const map = {
    sc_store: "BOT khusus jualan (¬±200+ fitur store). Free Rename + Free Panel Unli 1 bulan + Garansi 6 bulan.",
    sc_md: "Serbaguna 1000+ fitur. Free Rename + Free Panel Unli 1 bulan + Garansi 6 bulan.",
    sc_yna_ai: "BOT paling canggih (850+ fitur AI). Free Rename + Free Panel Unli 1 bulan + Full Setup.",
  };
  $("desc").innerText = map[val] || "";
}
updateDesc();
$("product").addEventListener("change", updateDesc);

$("btnCopy").addEventListener("click", async ()=>{
  const text = $("resultText").innerText;
  try{
    await navigator.clipboard.writeText(text);
    $("btnCopy").innerText = "Copied ‚úÖ";
    setTimeout(()=> $("btnCopy").innerText = "Copy Data", 1200);
  }catch{
    alert("Gagal copy. Tekan & tahan untuk salin manual.");
  }
});

$("scriptForm").addEventListener("submit", async (e)=>{
  e.preventDefault();

  const msg = $("msg");
  const btn = $("btnPay");
  msg.textContent = "";
  $("resultBox").style.display = "none";
  $("resultText").innerHTML = "";

  const name = $("name").value.trim();
  const wa = normWA($("wa").value);
  const product = $("product").value;
  const opt = $("product").selectedOptions[0];
  const amount = Number(opt.getAttribute("data-amount"));

  if(!name) return msg.textContent = "Nama wajib diisi.";
  if(!wa || wa.length < 10) return msg.textContent = "Nomor WhatsApp tidak valid.";
  if(!product) return msg.textContent = "Pilih script dulu.";
  if(!amount) return msg.textContent = "Nominal tidak valid.";

  $("payBox").style.display = "block";
  $("status").innerText = "Membuat QRIS...";
  $("orderInfo").innerText = "";
  $("qris").innerHTML = "";
  btn.disabled = true;

  try{
    // 1) CREATE ORDER (payload LENGKAP!)
    const pay = await createOrder({
      type: "script",
      name,
      wa,
      product,
      amount
    });

    $("orderInfo").innerHTML =
      `<b>Order ID:</b> ${pay.order_id}<br>` +
      `<b>Nominal:</b> Rp${rupiah(pay.amount)}<br>` +
      `<span class="muted">Scan QRIS di bawah ini untuk bayar.</span>`;

    renderQR(pay.qr_string);
    $("status").innerText = "üì≤ Scan QRIS ‚Üí bayar ‚Üí tunggu konfirmasi...";

    // 2) POLL STATUS
    await pollStatus(pay.order_id, pay.amount);

    $("status").innerText = "‚úÖ Pembayaran sukses! Mengambil link download...";

    // 3) FULFILL (ini pake api/fulfill-script.js yang aku kasih)
    const f = await fetch("/api/fulfill-script",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        order_id: pay.order_id,
        amount: pay.amount,
        wa,
        name,
        product
      })
    });
    const fj = await f.json();
    if(!f.ok || fj.error) throw new Error(fj.error || "Fulfill gagal");

    $("resultBox").style.display = "block";
    $("resultText").innerHTML = `
Order ID: ${fj.order_id}
Produk: ${fj.product_name}
Download: ${fj.download_url}
Grup Buyer: ${fj.buyer_group}
Admin WA: ${fj.admin_wa}
    `.trim();

    $("status").innerText = "‚úÖ Selesai. Link download sudah muncul.";
    btn.disabled = false;
  }catch(err){
    $("status").innerText = "‚ùå Gagal: " + (err.message || err);
    btn.disabled = false;
  }
});
</script>

</body>
</html>
